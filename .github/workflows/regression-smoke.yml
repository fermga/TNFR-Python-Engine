name: Regression Smoke (Bifurcation Tetrad)

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev-minimal]"

      - name: Run bifurcation smoke sweep (with optional baseline compare)
        run: |
          set -e
          mkdir -p results
          BASELINE="presets/regression/bifurcation_smoke.baseline.jsonl"
          if [ -f "$BASELINE" ]; then
            echo "Using baseline: $BASELINE"
            python tools/run_tetrad_regression.py \
              --output results/bifurcation_smoke.jsonl \
              --baseline "$BASELINE" \
              --tolerance 5e-3 \
              --nodes 150 \
              --seeds 1 \
              --topologies ring,ws \
              --oz-intensity-grid 1.2 \
              --vf-grid 1.0 \
              --mutation-thresholds 1.3 | tee results/regression_summary.txt
          else
            echo "No baseline found; running smoke only"
            python tools/run_tetrad_regression.py \
              --output results/bifurcation_smoke.jsonl \
              --nodes 150 \
              --seeds 1 \
              --topologies ring,ws \
              --oz-intensity-grid 1.2 \
              --vf-grid 1.0 \
              --mutation-thresholds 1.3 | tee results/regression_summary.txt
          fi

      - name: Upload artifact (JSONL + summary)
        uses: actions/upload-artifact@v4
        with:
          name: bifurcation-smoke-results
          path: |
            results/bifurcation_smoke.jsonl
            results/regression_summary.txt